import proj4 from "proj4";
import * as math from "mathjs";

// --- еліпсоїди
const WGS84 = { a: 6378137.0, f: 1 / 298.257223563 };
const KRASS = { a: 6378245.0, f: 1 / 298.3 };

// --- СК63 зона 3 (λ0 = 30°)
proj4.defs(
  "SK63_ZONE3",
  "+proj=tmerc +lat_0=0 +lon_0=30 +k=1 +x_0=3300000 +y_0=0 +ellps=krass +units=m +no_defs",
);

proj4.defs("WGS84", "+proj=longlat +datum=WGS84 +no_defs");

// --- геодезичні → ECEF
function geodeticToECEF(lat, lon, h, ell) {
  const a = ell.a;
  const f = ell.f;
  const e2 = 2 * f - f * f;

  const φ = (lat * Math.PI) / 180;
  const λ = (lon * Math.PI) / 180;

  const sinφ = Math.sin(φ);
  const cosφ = Math.cos(φ);

  const N = a / Math.sqrt(1 - e2 * sinφ * sinφ);

  const X = (N + h) * cosφ * Math.cos(λ);
  const Y = (N + h) * cosφ * Math.sin(λ);
  const Z = (N * (1 - e2) + h) * sinφ;

  return [X, Y, Z];
}

// --- твої точки
const points = [
  [51.563757, 28.02927, 5706732.322, 3198135.314],
  [51.372056, 29.443621, 5684379.958, 3296192.231],
  [52.074389, 30.970844, 5763542.888, 3400963.652],
  [50.371561, 28.0023, 5574149.785, 3193571.506],
  [50.397948, 29.522446, 5576012.288, 3301713.619],
  [50.334234, 30.997821, 5569997.241, 3406756.186],
  [49.224276, 28.005082, 5446545.388, 3191225.509],
  [49.188884, 29.528927, 5441533.78, 3302226.322],
  [49.072351, 30.991869, 5429645.354, 3409120.489],
  [48.326519, 28.001437, 5346719.207, 3188995.383],
  [48.361296, 29.522812, 5349500.723, 3301808.308],
  [48.282156, 30.990077, 5341773.905, 3410706.155],
  [47.329538, 29.419758, 5234785.32, 3294051.836],
  [47.308432, 30.995825, 5233520.443, 3413226.736],
  [45.453211, 28.289297, 5026925.006, 3205411.5],
  [45.215474, 29.745632, 4999818.325, 3319411.207],
  [46.592513, 30.986793, 5153920.365, 3414052.934],
];

// --- формуємо систему
const A = [];
const L = [];

points.forEach(([lat, lon, X, Y]) => {
  const [X1, Y1, Z1] = geodeticToECEF(lat, lon, 0, WGS84);

  const [lon2, lat2] = proj4("SK63_ZONE3", "WGS84", [Y, X]);
  const [X2, Y2, Z2] = geodeticToECEF(lat2, lon2, 0, KRASS);

  A.push([1, 0, 0, 0, Z2, -Y2, X2]);
  A.push([0, 1, 0, -Z2, 0, X2, Y2]);
  A.push([0, 0, 1, Y2, -X2, 0, Z2]);

  L.push(X1 - X2);
  L.push(Y1 - Y2);
  L.push(Z1 - Z2);
});

// --- рішення МНК
const AT = math.transpose(A);
const N = math.multiply(AT, A);
const U = math.multiply(AT, L);

const params = math.multiply(math.inv(N), U);

const [dx, dy, dz, rx, ry, rz, m] = params;

// console.log("Helmert params:", {
//   dx,
//   dy,
//   dz,
//   rx,
//   ry,
//   rz,
//   m,
// });

// --- основна функція
export function sk63z3ToWgs84(coordArray = []) {
  const wgsArray = [];
  for (const [y, x] of coordArray) {
    const [lon, lat] = proj4("SK63_ZONE3", "WGS84", [y, x]);
    const [X, Y, Z] = geodeticToECEF(lat, lon, 0, KRASS);

    const X2 = dx + (1 + m) * X - rz * Y + ry * Z;
    const Y2 = dy + rz * X + (1 + m) * Y - rx * Z;
    const Z2 = dz - ry * X + rx * Y + (1 + m) * Z;

    const lon2 = Math.atan2(Y2, X2);
    const p = Math.sqrt(X2 * X2 + Y2 * Y2);

    let lat2 = Math.atan2(Z2, p * (1 - 0.00669438));

    for (let i = 0; i < 5; i++) {
      const N = 6378137 / Math.sqrt(1 - 0.00669438 * Math.sin(lat2) ** 2);
      lat2 = Math.atan2(Z2, p * (1 - (0.00669438 * N) / N));
    }

    wgsArray.push([(lat2 * 180) / Math.PI, (lon2 * 180) / Math.PI]);
  }

  return wgsArray;
}

// =================================================================

// 11 51.563757 28.029270 153
// 12 51.372056 29.443621 155
// 13 52.074389 30.970844 135
// 21 50.371561 28.002300 242
// 22 50.397948 29.522446 184
// 23 50.334234 30.997821 109
// 31 49.224276 28.005082 332
// 32 49.188884 29.528927 230
// 33 49.072351 30.991869 171
// 41 48.326519 28.001437 57
// 42 48.361296 29.522812 164
// 43 48.282156 30.990077 162
// 52 47.329538 29.419758 135
// 53 47.308432 30.995825 106
// 61 45.453211 28.289297 9
// 62 45.215474 29.745632 0
// 63 46.592513 30.986793 37

//  11     5706732.322     3198135.314    127.765
//  12     5684379.958     3296192.231    131.529
//  13     5763542.888     3400963.652    111.965
//  21     5574149.785     3193571.506    212.358
//  22     5576012.288     3301713.619    156.825
//  23     5569997.241     3406756.186     84.613
//  31     5446545.388     3191225.509    299.790
//  32     5441533.780     3302226.322    200.590
//  33     5429645.354     3409120.489    144.928
//  41     5346719.207     3188995.383     24.659
//  42     5349500.723     3301808.308    133.839
//  43     5341773.905     3410706.155    134.116
//  52     5234785.320     3294051.836    105.227
//  53     5233520.443     3413226.736     77.993
//  61     5026925.006     3205411.500    -22.231
//  62     4999818.325     3319411.207    -30.559
//  63     5153920.365     3414052.934      9.832

// 1 51.494994 31.159013  =   5698903.784     4206988.506
// 2 51.525657 32.500554  =   5701461.986     4300154.764
// 3 51.678669 33.900568  =   5719414.881     4396990.645
// 11 49.422179 31.240523  =   5468237.381     4208738.835
// 12 49.398545 32.592473  =   5464849.651     4306827.214
// 13 49.343724 33.950651  =   5459760.597     4405528.181
// 21 46.614316 31.092164  =   5156228.487     4192272.332
// 22 46.074748 32.501527  =   5095287.814     4300231.941
// 23 44.396419 33.925787  =   4909752.662     4413706.609
